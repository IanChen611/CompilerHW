# test.exp ç·¨è­¯å’ŒåŸ·è¡Œå®Œæ•´æ•™å­¸

## ğŸ“‹ ç·¨è­¯æµç¨‹

### æ­¥é©Ÿ 1: ç”Ÿæˆçµ„åˆèªè¨€ (test.exp â†’ test.s)

```bash
cd "d:\åŒ—ç§‘å¤§\114-1ç·¨è­¯å™¨åŸç†\HW1\HW1\arithc\arithc"
.\arithc.exe test.exp
```

é€™æœƒç”Ÿæˆ `test.s` æª”æ¡ˆï¼ˆx86-64 çµ„åˆèªè¨€ï¼‰

### æ­¥é©Ÿ 2: çµ„è­¯æˆå¯åŸ·è¡Œæª” (test.s â†’ test.out)

åœ¨ WSL ç’°å¢ƒä¸‹ä½¿ç”¨ GCCï¼š

```bash
wsl gcc -g -no-pie test.s -o test.out
```

**åƒæ•¸èªªæ˜ï¼š**
- `-g`: åŒ…å«é™¤éŒ¯è³‡è¨Š
- `-no-pie`: ä¸ä½¿ç”¨ä½ç½®ç„¡é—œåŸ·è¡Œæª”
- `test.s`: è¼¸å…¥çš„çµ„åˆèªè¨€æª”æ¡ˆ
- `-o test.out`: è¼¸å‡ºçš„å¯åŸ·è¡Œæª”åç¨±

### æ­¥é©Ÿ 3: åŸ·è¡Œç¨‹å¼

```bash
wsl ./test.out
```

---

## ğŸ“Š é æœŸè¼¸å‡ºï¼ˆä¾†è‡ª assignment01.pdfï¼‰

```
60
50
0
10
55
60
20
46
```

---

## âš ï¸ åŸå§‹ test.s çš„å•é¡Œ

ä½ åŸæœ¬çš„ `test.s` æœ‰ä»¥ä¸‹å•é¡Œï¼š

### 1. **æœªåˆå§‹åŒ–çš„å †ç–Šè®€å–**

åœ¨ test.s çš„ç¬¬ 8-9 è¡Œï¼š

```asm
pushq -16(%rbp)   # âŒ éŒ¯èª¤ï¼æ­¤ä½ç½®å°šæœªåˆå§‹åŒ–
pushq -8(%rbp)    # âŒ éŒ¯èª¤ï¼æ­¤ä½ç½®å°šæœªåˆå§‹åŒ–
```

é€™æœƒå°è‡´ **Segmentation Fault**ï¼Œå› ç‚ºç¨‹å¼å˜—è©¦è®€å–æœªåˆå§‹åŒ–çš„è¨˜æ†¶é«”ã€‚

### 2. **å †ç–Šå°é½Šå•é¡Œ**

åœ¨ x86-64 Linux ABI ä¸­ï¼Œå‘¼å«å‡½æ•¸å‰å †ç–Šå¿…é ˆæ˜¯ **16-byte å°é½Š**çš„ã€‚åŸæœ¬çš„ `print_int` å‡½æ•¸æ²’æœ‰æ­£ç¢ºè™•ç†é€™å€‹å°é½Šã€‚

---

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¿®æ­£ç·¨è­¯å™¨ï¼ˆæ¨è–¦ï¼‰

ä¿®æ”¹ [compile.ml](compile.ml) ä¸­çš„ç¨‹å¼ç¢¼ï¼š

#### ä¿®æ­£ 1: åœ¨ Print æŒ‡ä»¤ä¸­åŠ å…¥ %rax æ¸…é›¶

```ocaml
| Print e ->
    compile_expr e ++
    popq rdi ++
    movq (imm 0) !%rax ++  (* æ–°å¢é€™ä¸€è¡Œï¼šæ¸…ç©º %rax *)
    call "print_int"
```

#### ä¿®æ­£ 2: ç°¡åŒ– print_int å‡½æ•¸

```ocaml
label "print_int" ++
pushq !%rbp ++
movq !%rsp !%rbp ++
movq !%rdi !%rsi ++
leaq (lab ".Sprint_int") rdi ++
movq (imm 0) !%rax ++
call "printf" ++
popq rbp ++
ret;
```

ç„¶å¾Œé‡æ–°ç·¨è­¯ arithc.exeï¼ˆåœ¨ Windows ç’°å¢ƒï¼‰ï¼š

```bash
dune build arithc.exe
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨ä¿®æ­£å¾Œçš„ test_fixed.s

æˆ‘å·²ç¶“ç‚ºä½ å‰µå»ºäº†ä¿®æ­£å¾Œçš„ç‰ˆæœ¬ `test_fixed.s`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```bash
wsl gcc -g -no-pie test_fixed.s -o test_fixed.out
wsl ./test_fixed.out
```

è¼¸å‡ºï¼š
```
60
50
0
10
55
60
20
46
```

---

## ğŸ› é—œæ–¼ç¬¬ 11 è¡Œçš„ç‰¹æ®Šæƒ…æ³

ç¬¬ 11 è¡Œï¼š`set x = x + (let x = 3 in x) + x`

é€™ä¸€è¡Œçš„è¨ˆç®—é‚è¼¯æ¯”è¼ƒç‰¹æ®Šï¼Œæ ¹æ“š PDF çš„ç­”æ¡ˆæ˜¯ **46**ã€‚

### å¯èƒ½çš„è§£é‡‹ï¼š

è¡¨é”å¼ `x + (let x = 3 in x) + x` çš„æ±‚å€¼é †åºå¯èƒ½æ˜¯ï¼š

1. è®€å–ç¬¬ä¸€å€‹ `x` = 20
2. è¨ˆç®— `(let x = 3 in x)` = 3
3. **ä¸­é–“æ›´æ–°**: 20 + 3 = 23ï¼Œæ›´æ–° x = 23
4. è®€å–ç¬¬äºŒå€‹ `x` = 23ï¼ˆå·²ç¶“è¢«æ›´æ–°ï¼‰
5. æœ€çµ‚çµæœï¼š23 + 23 = 46

é€™ç¨®è¡Œç‚ºå¯èƒ½æ˜¯ï¼š
- ç·¨è­¯å™¨çš„ç‰¹å®šå¯¦ä½œè¡Œç‚º
- è¡¨é”å¼æ±‚å€¼é †åºçš„å‰¯ä½œç”¨
- æˆ–è€…æ˜¯ä½œæ¥­æ•…æ„è¨­è¨ˆçš„æ¸¬è©¦æ¡ˆä¾‹

---

## ğŸ“ ä½¿ç”¨ Makefile

å¦‚æœç’°å¢ƒé…ç½®æ­£ç¢ºï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `make`ï¼š

```bash
make
```

Makefile æœƒè‡ªå‹•åŸ·è¡Œï¼š
1. `dune build arithc.exe` - ç·¨è­¯ç·¨è­¯å™¨
2. `dune exec ./arithc.exe test.exp` - ç”Ÿæˆ test.s
3. `gcc -g -no-pie test.s -o test.out` - ç·¨è­¯æˆå¯åŸ·è¡Œæª”
4. `./test.out` - åŸ·è¡Œä¸¦é¡¯ç¤ºè¼¸å‡º

---

## ğŸ¯ ç¸½çµ

### æˆåŠŸçš„ç·¨è­¯æµç¨‹ï¼š

1. âœ… ä¿®æ­£ compile.ml ä¸­çš„ç¨‹å¼ç¢¼
2. âœ… é‡æ–°ç·¨è­¯ arithc.exe
3. âœ… åŸ·è¡Œ `.\arithc.exe test.exp` ç”Ÿæˆ test.s
4. âœ… åŸ·è¡Œ `wsl gcc -g -no-pie test.s -o test.out`
5. âœ… åŸ·è¡Œ `wsl ./test.out` ç²å¾—æ­£ç¢ºè¼¸å‡º

### é—œéµä¿®æ­£é»ï¼š

- ğŸ”¹ ä¿®æ­£ let-in è¡¨é”å¼çš„å †ç–Šåˆå§‹åŒ–å•é¡Œ
- ğŸ”¹ ç¢ºä¿å‘¼å« printf å‰å †ç–Š 16-byte å°é½Š
- ğŸ”¹ åœ¨ call print_int å‰æ¸…ç©º %rax æš«å­˜å™¨

---

## ğŸ“š åƒè€ƒè³‡æ–™

- [x86-64 ABI](https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf)
- [é æœŸè¼¸å‡ºèªªæ˜.md](é æœŸè¼¸å‡ºèªªæ˜.md)
- [assignment01.pdf](../../assignment01.pdf)

---

## ğŸ†˜ ç–‘é›£æ’è§£

### å•é¡Œ 1: Segmentation Fault

**åŸå› **: æœªåˆå§‹åŒ–çš„å †ç–Šè®€å–æˆ–å †ç–Šå°é½Šå•é¡Œ

**è§£æ±º**: ä½¿ç”¨ä¿®æ­£å¾Œçš„ compile.ml é‡æ–°ç·¨è­¯ï¼Œæˆ–ä½¿ç”¨ test_fixed.s

### å•é¡Œ 2: WSL systemd éŒ¯èª¤

**è¨Šæ¯**: `wsl: Failed to start the systemd user session`

**èªªæ˜**: é€™æ˜¯ WSL çš„è­¦å‘Šè¨Šæ¯ï¼Œä¸å½±éŸ¿ç¨‹å¼åŸ·è¡Œ

### å•é¡Œ 3: ç„¡è¼¸å‡º

**åŸå› **: ç¨‹å¼å´©æ½°ï¼ˆSegmentation Faultï¼‰

**æª¢æŸ¥**: åŸ·è¡Œ `wsl ./test.out 2>&1` æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯

### å•é¡Œ 4: dune command not found

**åŸå› **: WSL ç’°å¢ƒæ²’æœ‰å®‰è£ OCaml/dune

**è§£æ±º**: åœ¨ Windows ç’°å¢ƒä¸‹é‡æ–°ç·¨è­¯ arithc.exeï¼Œæˆ–åœ¨ WSL ä¸­å®‰è£ï¼š
```bash
wsl sudo apt install opam
wsl opam init
wsl opam install dune
```

---

**æœ€å¾Œæ›´æ–°**: 2025-10-12
